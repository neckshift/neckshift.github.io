<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NeckShift – Comments</title>
<style>
  :root{--fg:#E9E3E3;--muted:#B3A8A8;--line:rgba(255,255,255,.14);--bg:#121212;--glass:rgba(28,28,28,.65);--glass2:rgba(24,24,24,.85);--green:#6ef0a8;--devBubble:rgba(120,200,170,.10)}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);scrollbar-width:none}
  ::-webkit-scrollbar{width:0;height:0}
  .background{position:fixed;inset:0;z-index:-1;overflow:hidden}
  .background img{width:100%;height:100%;object-fit:cover;filter:brightness(.28)}
  .wrap{max-width:920px;margin:28px auto;padding:0 16px}
  .sticky{position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);background:var(--glass2);border:1px solid var(--line);border-radius:16px}
  .head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid var(--line)}
  h2{margin:0;font-size:20px;color:#e8dfdf;font-weight:600}
  .btn,.btn-small{border:1px solid rgba(255,255,255,.3);background:none;color:var(--muted);border-radius:8px;cursor:pointer;transition:.2s}
  .btn{padding:10px 12px;font-size:15px}.btn-small{padding:6px 9px;font-size:13px}
  .btn:hover{background:#3d3d3d;color:#fff}
  #adminPanel{display:none;gap:8px;align-items:center}
  #adminPanel input{background:transparent;border:1px solid rgba(255,255,255,.25);color:#eee;border-radius:8px;padding:7px 9px}

  .tabs{display:flex;gap:8px;padding:10px 12px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--line);color:#cfc7c7;cursor:pointer;background:rgba(255,255,255,.02)}
  .tab.active{color:#111;background:#bfe8d2;border-color:#bfe8d2}

  .form{padding:12px;border-top:1px solid var(--line)}
  .row{display:grid;grid-template-columns:1fr;gap:10px}
  input[type="text"],textarea{background:rgba(44,44,44,.35);border:1px solid rgba(255,255,255,.25);color:#eee;padding:10px 12px;border-radius:10px;font-size:15px}
  textarea{width:100%;min-height:110px;resize:vertical}
  .post-btn{margin-top:10px}

  .panel{margin-top:14px;background:var(--glass);border:1px solid var(--line);border-radius:16px}
  .list{padding:6px 12px}
  .thread{padding:14px 10px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.02)}
  .thread:nth-child(odd){background:rgba(0,0,0,.18)}
  .meta{font-size:13px;color:#b6b6b6;margin-bottom:6px}
  .name{font-weight:600;color:#f0eded}.time{color:#9e9e9e;margin-left:8px}
  .text{white-space:pre-wrap;line-height:1.6;color:#e9e3e3}
  .dev-reply{margin-top:10px;margin-left:12px;padding:10px 12px;border-left:3px solid var(--green);background:var(--devBubble);border-radius:10px}
  .dev-reply .by{color:var(--green);font-weight:600;margin-right:6px}
  .user-follow{margin-top:8px;margin-left:12px;padding-left:12px;border-left:2px solid rgba(255,255,255,.15);color:#ddd}
  .actions{display:flex;gap:6px;margin-top:8px}
  .inlinebox{display:none;margin-top:8px}
  .inlinebox textarea{width:100%;min-height:80px}
</style>
</head>
<body>
  <div class="background"><img src="../createbackground.png" alt=""></div>

  <div class="wrap">
    <div class="sticky">
      <div class="head">
        <h2>Comments</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="adminToggle" class="btn-small" title="Enter admin password">Admin mode</button>
          <div id="adminPanel">
            <input id="adminPassword" type="password" placeholder="Admin password" autocomplete="off" />
            <button id="adminUse" class="btn-small">Use</button>
            <button id="adminCancel" class="btn-small">Cancel</button>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-topic="thanks">Thanks</button>
        <button class="tab" data-topic="feature">Feature request</button>
        <button class="tab" data-topic="bug">Bug report</button>
      </div>

      <div class="form">
        <div class="row">
          <input type="text" id="name" placeholder="Your name (optional)" maxlength="40">
          <textarea id="message" placeholder="Write your comment..." maxlength="1500" required></textarea>
          <button id="postBtn" class="btn post-btn">Post comment</button>
          <div id="status" style="margin-top:6px;font-size:14px;color:#d9bebe"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div id="list" class="list"></div>
    </div>
  </div>

<script>
  const API_BASE = "https://neckshift-comments.brd-louu.workers.dev";
  const API = API_BASE + "/comments";

  // Admin session
  let ADMIN_TOKEN = sessionStorage.getItem("ns_admin_token") || "";
  const isAdmin = () => !!ADMIN_TOKEN;

  // Owner token (for edit/delete own top-level)
  const OWNER_TOKEN_KEY = "ns_owner_token";
  if (!localStorage.getItem(OWNER_TOKEN_KEY)) {
    const t = crypto.getRandomValues(new Uint8Array(16)).reduce((s,b)=>s+("0"+b.toString(16)).slice(-2),"");
    localStorage.setItem(OWNER_TOKEN_KEY, t);
  }
  const OWNER_TOKEN = localStorage.getItem(OWNER_TOKEN_KEY);
  const OWNED_KEY = "ns_owned_ids";

  // UI helpers
  function escapeHtml(s){return (s||"").replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function linkify(s){return (s||"").replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');}
  function fmtDate(s){ try{ return new Date(s||Date.now()).toLocaleString(); }catch{ return ""; } }

  // Tabs
  let currentTopic = "thanks";
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentTopic = btn.dataset.topic;
      loadComments();
    });
  });

  // Admin UI
  const adminBtn=document.getElementById("adminToggle");
  const adminPanel=document.getElementById("adminPanel");
  const adminPwd=document.getElementById("adminPassword");
  const adminUse=document.getElementById("adminUse");
  const adminCancel=document.getElementById("adminCancel");

  function refreshAdminUI(){
    adminBtn.textContent = isAdmin() ? "Admin mode: ON" : "Admin mode";
    adminBtn.style.color = isAdmin() ? "#9fd" : "";
    adminPanel.style.display="none";
  }
  adminBtn.addEventListener("click", ()=>{
    if (isAdmin()) {
      if (confirm("Disable admin mode?")) {
        ADMIN_TOKEN=""; sessionStorage.removeItem("ns_admin_token");
        refreshAdminUI(); loadComments();
      }
    } else { adminPanel.style.display="flex"; adminPwd.value=""; adminPwd.focus(); }
  });
  adminUse.addEventListener("click", async ()=>{
    const t = adminPwd.value.trim(); if (!t) return;
    const r = await fetch(API_BASE + "/admin/verify", { method:"POST", headers:{ "Authorization":`Bearer ${t}` } });
    const ok = r.ok && (await r.json().catch(()=>({ok:false}))).ok;
    if (!ok) { alert("Wrong password"); return; }
    ADMIN_TOKEN = t; sessionStorage.setItem("ns_admin_token", t);
    refreshAdminUI(); loadComments();
  });
  adminCancel.addEventListener("click", ()=>{ adminPanel.style.display="none"; adminPwd.value=""; });
  refreshAdminUI();

  // Post top-level
  document.getElementById("postBtn").addEventListener("click", submitComment);
  async function submitComment(){
    const statusEl = document.getElementById('status');
    statusEl.textContent = "";
    const name = document.getElementById('name').value.trim().slice(0,40);
    const message = document.getElementById('message').value.trim();
    if (!message || message.length < 2) { statusEl.textContent = "Message is too short."; return; }

    try{
      const r = await fetch(API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name, topic: currentTopic, message, owner: OWNER_TOKEN })
      });
      const data = await r.json().catch(()=>null);
      if (!r.ok) {
        statusEl.textContent =
          data?.error === 'rate_limited' ? "Please wait a minute before posting again." :
          data?.error || "Sorry, something went wrong.";
        return;
      }
      document.getElementById('message').value = "";

      // remember ownership
      const arr = JSON.parse(localStorage.getItem(OWNED_KEY)||"[]");
      if (!arr.includes(data.id)) { arr.push(data.id); localStorage.setItem(OWNED_KEY, JSON.stringify(arr)); }

      loadComments();
    }catch(e){ console.error(e); statusEl.textContent = "Network error. Please try again."; }
  }

  async function loadComments(){
    try{
      const r = await fetch(API);
      const all = await r.json();
      const data = (all||[]).filter(c=> (c.topic||"") === currentTopic);
      const list = document.getElementById('list');
      list.innerHTML = "";

      const owned = JSON.parse(localStorage.getItem(OWNED_KEY)||"[]");

      data.forEach(c=>{
        const wrap = document.createElement('div');
        wrap.className = 'thread';
        wrap.dataset.id = c.id;

        let html =
          `<div class="meta">
             <span class="name">${escapeHtml(c.name || 'Anonymous')}</span>
             <span class="time">${fmtDate(c.created_at)}</span>
           </div>
           <div class="text">${linkify(escapeHtml(c.message || ''))}</div>`;

        // thread entries (dev + user follow-ups)
        const t = Array.isArray(c.thread) ? c.thread : [];
        t.forEach(entry=>{
          if (entry.by === 'dev') {
            html += `<div class="dev-reply"><span class="by">Anatomie Sonore</span> ${linkify(escapeHtml(entry.message||''))}</div>`;
          } else {
            html += `<div class="user-follow"><span class="name">${escapeHtml(entry.name||'Anonymous')}</span> — ${linkify(escapeHtml(entry.message||''))}</div>`;
          }
        });

        // === LOGIQUE DEMANDÉE ===
        // bouton "Reply to dev" seulement s'il existe AU MOINS une réponse dev dans ce fil
        const hasDevReply = t.some(e => e.by === 'dev');

        // actions
        if (isAdmin()) {
          html += `<div class="actions">
                     <button class="btn-small" data-action="reply">Reply</button>
                     <button class="btn-small" data-action="delete">Delete</button>
                   </div>
                   <div class="inlinebox">
                     <textarea placeholder="Write a dev reply…"></textarea>
                     <div class="actions">
                       <button class="btn-small" data-action="send-reply">Send</button>
                       <button class="btn-small" data-action="cancel-reply">Cancel</button>
                     </div>
                   </div>`;
        } else {
          // pour les visiteurs : Reply-to-dev UNIQUEMENT si hasDevReply
          let visitorActions = `<div class="actions">`;
          if (hasDevReply) {
            visitorActions += `<button class="btn-small" data-action="reply-to-dev">Reply to dev</button>`;
          }
          if (owned.includes(c.id)) {
            visitorActions += `<button class="btn-small" data-action="edit">Edit</button>
                               <button class="btn-small" data-action="del">Delete</button>`;
          }
          visitorActions += `</div>`;
          html += visitorActions;

          if (hasDevReply) {
            html += `<div class="inlinebox">
                       <textarea placeholder="Write your reply to dev…"></textarea>
                       <div class="actions">
                         <button class="btn-small" data-action="send-user">Send</button>
                         <button class="btn-small" data-action="cancel-user">Cancel</button>
                       </div>
                     </div>`;
          }
        }

        wrap.innerHTML = html;
        list.appendChild(wrap);

        // wire
        if (isAdmin()) {
          const box = wrap.querySelector('.inlinebox');
          const ta  = box?.querySelector('textarea');
          wrap.querySelector('[data-action="reply"]')?.addEventListener('click', ()=>{
            box.style.display='block'; ta.value=""; ta.focus();
          });
          wrap.querySelector('[data-action="cancel-reply"]')?.addEventListener('click', ()=>{
            box.style.display='none'; ta.value="";
          });
          wrap.querySelector('[data-action="send-reply"]')?.addEventListener('click', async ()=>{
            const text = (ta.value||"").trim(); if (!text) return;
            const rr = await fetch(`${API}/${c.id}/reply`, {
              method:"POST",
              headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${ADMIN_TOKEN}` },
              body: JSON.stringify({ reply: text })
            });
            if (!rr.ok){ alert("Reply failed"); return; }
            loadComments();
          });
          wrap.querySelector('[data-action="delete"]')?.addEventListener('click', async ()=>{
            if (!confirm('Delete this thread?')) return;
            const rr = await fetch(`${API}/${c.id}`, {
              method:"DELETE",
              headers:{ "Authorization":`Bearer ${ADMIN_TOKEN}` }
            });
            if (!rr.ok){ alert("Delete failed"); return; }
            loadComments();
          });
        } else {
          const box = wrap.querySelector('.inlinebox');
          const ta  = box?.querySelector('textarea');
          wrap.querySelector('[data-action="reply-to-dev"]')?.addEventListener('click', ()=>{
            if (!box) return;
            box.style.display='block'; ta.value=""; ta.focus();
          });
          wrap.querySelector('[data-action="cancel-user"]')?.addEventListener('click', ()=>{
            if (!box) return;
            box.style.display='none'; ta.value="";
          });
          wrap.querySelector('[data-action="send-user"]')?.addEventListener('click', async ()=>{
            if (!box) return;
            const text = (ta.value||"").trim(); if (!text) return;
            const rr = await fetch(`${API}/${c.id}/followup`, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ name: document.getElementById('name').value.trim().slice(0,40), message: text })
            });
            if (!rr.ok){ alert("Send failed"); return; }
            loadComments();
          });

          // owner edit/del
          wrap.querySelector('[data-action="del"]')?.addEventListener('click', async ()=>{
            if (!confirm('Delete your thread?')) return;
            const rr = await fetch(`${API}/${c.id}`, {
              method:"DELETE",
              headers:{ "Authorization": `Bearer owner:${OWNER_TOKEN}` }
            });
            if (!rr.ok){ alert("Delete failed"); return; }
            const arr = JSON.parse(localStorage.getItem(OWNED_KEY)||"[]").filter(id=>id!==c.id);
            localStorage.setItem(OWNED_KEY, JSON.stringify(arr));
            loadComments();
          });
          wrap.querySelector('[data-action="edit"]')?.addEventListener('click', async ()=>{
            const cur = prompt("Edit your message:", c.message||"");
            if (cur==null) return;
            const txt = String(cur).trim(); if (!txt) return;
            const rr = await fetch(`${API}/${c.id}`, {
              method:"PATCH",
              headers:{ "Content-Type":"application/json", "Authorization": `Bearer owner:${OWNER_TOKEN}` },
              body: JSON.stringify({ message: txt })
            });
            if (!rr.ok){ alert("Edit failed"); return; }
            loadComments();
          });
        }
      });
    }catch(e){ console.error(e); }
  }

  // init + admin verify then load
  (async ()=>{
    if (isAdmin()) {
      try {
        const r = await fetch(API_BASE + "/admin/verify", { method:"POST", headers:{ "Authorization":`Bearer ${ADMIN_TOKEN}` } });
        const ok = r.ok && (await r.json().catch(()=>({ok:false}))).ok;
        if (!ok) { ADMIN_TOKEN=""; sessionStorage.removeItem("ns_admin_token"); refreshAdminUI(); }
      } catch {}
    }
    loadComments();
  })();
</script>
</body>
</html>
