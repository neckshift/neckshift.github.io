<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Comments</title>
<style>
:root {
  --userBubble: rgba(255,255,255,.08);
  --devBubble: rgba(0,200,120,.15);
}

body {
  font-family: sans-serif;
  background: #0d0d0d;
  color: white;
  margin: 0;
  padding: 0;
}

/* Barre des topics */
#topics {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #1a1a1a;
  position: sticky;
  top: 0;
  z-index: 20;
}
#topics button {
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  background: #333;
  color: white;
}
#topics button.active[data-topic="thanks"] { background: #28a745; }
#topics button.active[data-topic="feature"] { background: #007bff; }
#topics button.active[data-topic="bug"] { background: #dc3545; }

/* Formulaire */
#form {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 10px;
}
#form input, #form textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
}
#form button {
  padding: 8px;
  border: none;
  border-radius: 6px;
  background: #28a745;
  color: white;
  cursor: pointer;
}

/* Messages */
.thread {
  border-bottom: 1px solid rgba(255,255,255,.1);
  padding: 8px;
}
.thread-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.thread-header .meta {
  font-size: 0.9em;
  opacity: 0.7;
}
.thread-header .actions button {
  margin-left: 6px;
  background: none;
  border: none;
  cursor: pointer;
  color: #bbb;
}

.bubble-row {
  display: flex;
  width: 100%;
  margin-top: 8px;
}
.bubble-row.user { justify-content: flex-start; }
.bubble-row.dev { justify-content: flex-end; }

.bubble {
  width: 78%;
  padding: 8px 10px;
  border-radius: 14px;
  line-height: 1.4;
  font-size: 15px;
  box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset;
  word-wrap: break-word;
  overflow-wrap: anywhere;
}
.bubble.user { background: var(--userBubble); }
.bubble.dev {
  background: var(--devBubble);
  border: 1px solid rgba(110,240,168,.25);
}

.who {
  display: block;
  margin-bottom: 3px;
  font-style: italic;
  font-size: 1.04rem;
  opacity: .95;
}
</style>
</head>
<body>

<div id="topics">
  <button data-topic="thanks" class="active">Thanks</button>
  <button data-topic="feature">Feature request</button>
  <button data-topic="bug">Bug report</button>
</div>

<div id="form">
  <input id="name" placeholder="Name">
  <textarea id="message" placeholder="Write your comment..."></textarea>
  <button id="post">Post</button>
</div>

<div id="comments"></div>

<script>
const API = "https://neckshift-comments.brd-louu.workers.dev";
let currentTopic = "thanks";
let isAdmin = false;
let adminToken = "";

document.querySelectorAll('#topics button').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#topics button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentTopic = btn.dataset.topic;
    loadComments();
  };
});

document.getElementById('post').onclick = async () => {
  const name = document.getElementById('name').value;
  const message = document.getElementById('message').value;
  const res = await fetch(API + "/comments", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name, topic: currentTopic, message })
  });
  if (res.ok) {
    document.getElementById('message').value = "";
    loadComments();
  } else {
    alert("Send fail");
  }
};

async function loadComments() {
  const res = await fetch(API + "/comments");
  const data = await res.json();
  const filtered = data.filter(c => c.topic === currentTopic);
  const container = document.getElementById('comments');
  container.innerHTML = "";
  filtered.forEach(c => {
    const thread = document.createElement('div');
    thread.className = 'thread';
    const header = document.createElement('div');
    header.className = 'thread-header';
    header.innerHTML = `<div><strong>${c.name || "Anonymous"}</strong></div>
                        <div class="meta">${new Date(c.created_at).toLocaleString()}</div>`;
    const actions = document.createElement('div');
    actions.className = 'actions';

    if (isAdmin) {
      const replyBtn = document.createElement('button');
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => replyTo(c.id);
      const delBtn = document.createElement('button');
      delBtn.textContent = "Delete";
      delBtn.onclick = () => deleteComment(c.id);
      actions.appendChild(replyBtn);
      actions.appendChild(delBtn);
    } else {
      if (c.replies && c.replies.length > 0) {
        const replyDevBtn = document.createElement('button');
        replyDevBtn.textContent = "Reply to dev";
        replyDevBtn.onclick = () => replyToDev(c.id);
        actions.appendChild(replyDevBtn);
      }
    }

    header.appendChild(actions);
    thread.appendChild(header);

    // Message principal
    const mainRow = document.createElement('div');
    mainRow.className = 'bubble-row user';
    mainRow.innerHTML = `<div class="bubble user"><span class="who">${c.name || "Anonymous"}</span>${c.message}</div>`;
    thread.appendChild(mainRow);

    // Réponses
    if (c.replies) {
      c.replies.forEach(r => {
        const row = document.createElement('div');
        row.className = 'bubble-row ' + (r.by === "Anatomie Sonore" ? 'dev' : 'user');
        row.innerHTML = `<div class="bubble ${r.by === "Anatomie Sonore" ? 'dev' : 'user'}">
                           <span class="who">${r.by}</span>${r.message}
                         </div>`;
        thread.appendChild(row);
      });
    }

    container.appendChild(thread);
  });
}

async function replyTo(id) {
  const reply = prompt("Reply:");
  if (!reply) return;
  const res = await fetch(API + `/comments/${id}/reply`, {
    method: "POST",
    headers: {"Content-Type": "application/json", "Authorization": "Bearer " + adminToken},
    body: JSON.stringify({ reply })
  });
  if (res.ok) loadComments();
  else alert("Reply fail");
}

async function replyToDev(id) {
  const reply = prompt("Reply to dev:");
  if (!reply) return;
  const res = await fetch(API + `/comments/${id}/reply`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ reply })
  });
  if (res.ok) loadComments();
  else alert("Send fail");
}

async function deleteComment(id) {
  if (!confirm("Delete comment?")) return;
  const res = await fetch(API + `/comments/${id}`, {
    method: "DELETE",
    headers: {"Authorization": "Bearer " + adminToken}
  });
  if (res.ok) loadComments();
  else alert("Delete fail");
}

// Mode admin auto si token déjà en mémoire
(async () => {
  const token = localStorage.getItem("adminToken");
  if (token) {
    const res = await fetch(API + "/admin/verify", {
      method: "POST",
      headers: {"Authorization": "Bearer " + token}
    });
    if (res.ok) {
      isAdmin = true;
      adminToken = token;
    }
  }
  loadComments();
})();
</script>

</body>
</html>
