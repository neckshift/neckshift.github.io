<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NeckShift - Comments</title>
<style>
  :root {
    --fg:#E9E3E3; --muted:#B3A8A8; --border:rgba(255,255,255,0.12);
    --bg:#212121; --card:rgba(48,48,48,0.6);
    --accent:#8fd; --danger:#f88; --ok:#9ef0d0;
  }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--muted); }
  .background{ position:fixed; inset:0; z-index:-1; overflow:hidden }
  .background img{ width:100%; height:100%; object-fit:cover; filter:brightness(.35) }
  .container{ max-width:860px; margin:24px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
  .header{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); }
  h2{ margin:0; color:#d9cfcf; font-weight:600; }
  .top-actions{ display:flex; gap:10px; align-items:center; }
  .btn{ border:1px solid #888; background:none; color:var(--muted); border-radius:8px; padding:8px 12px; cursor:pointer; }
  .btn:hover{ background:#555; color:#fff }
  .btn-small{ padding:6px 10px; border-radius:8px; }
  .sticky-form{ position:sticky; top:0; z-index:5; background:rgba(33,33,33,0.9); border-bottom:1px solid var(--border); }
  form{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; padding:14px 18px; }
  form .row-full{ grid-column:1/-1 }
  input, textarea, select{
    background: rgba(44,44,44,0.25); border:1px solid rgba(255,255,255,0.25); color:#eee; padding:10px; border-radius:10px; font-size:15px;
  }
  textarea{ min-height:96px; }
  label.inline{ display:flex; gap:8px; align-items:center; font-size:14px; color:#cfc6c6 }
  .status{ min-height:22px; font-size:14px; color:#d9bebe; padding:0 18px 12px }
  #list-wrap{ max-height:70vh; overflow:auto; padding:12px 18px 20px }
  .comment{ background: rgba(44,44,44,0.40); border:1px solid var(--border); border-radius:12px; padding:12px; margin-top:14px; position:relative }
  .comment[data-highlight="1"]{ outline:2px solid rgba(143,253,218,.35) }
  .meta{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:13px; color:#9a9a9a; margin-bottom:6px }
  .name{ color:#f0eded; font-weight:600 }
  time{ color:#b0b0b0; font-size:12px }
  .badge{ font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.2) }
  .badge-admin{ background: rgba(0,160,120,.15); border-color: rgba(0,160,120,.4); color:#9ef0d0 }
  .badge-unverified{ background: rgba(160,160,160,.1); border-color: rgba(160,160,160,.3); color:#cfcfcf }
  .badge-topic{ background: rgba(90,120,160,.12); border-color: rgba(90,120,160,.3) }
  .reply{ margin-top:10px; padding:10px; border-left:3px solid #5bb; background: rgba(120,180,200,.08); border-radius:8px }
  .admin-actions{ position:absolute; top:8px; right:8px; display:flex; gap:6px }
  .replybox{ display:none; margin-top:10px }
  .replybox textarea{ width:100%; min-height:80px }
  .replybox .actions{ display:flex; gap:8px; margin-top:6px }
</style>
</head>
<body>
  <div class="background"><img src="../createbackground.png" alt=""></div>

  <div class="container">
    <div class="card sticky-form">
      <div class="header">
        <h2>Comments</h2>
        <div class="top-actions">
          <button id="adminToggle" class="btn btn-small" title="Enter admin password">Admin mode</button>
          <div id="adminPanel" style="display:none; gap:8px; align-items:center">
            <input id="adminPassword" type="password" placeholder="Admin password" autocomplete="off" />
            <button id="adminUse" class="btn btn-small">Use</button>
            <button id="adminCancel" class="btn btn-small">Cancel</button>
          </div>
        </div>
      </div>

      <form id="commentForm" autocomplete="off" autocapitalize="off" autocorrect="off">
        <input class="row-full" type="text" id="name" placeholder="Your name (optional)" maxlength="40">
        <select id="topic">
          <option value="thanks">Thanks</option>
          <option value="feature">Feature request</option>
          <option value="bug">Bug report</option>
          <option value="other">Other</option>
        </select>
        <input type="email" id="email" placeholder="Email (optional, for reply notification)">
        <textarea class="row-full" id="message" placeholder="Write your comment..." maxlength="1500" required></textarea>
        <label class="inline"><input type="checkbox" id="notify" checked> Notify me when thereâ€™s a reply</label>
        <button class="row-full btn" type="submit">Post comment</button>
      </form>
      <div id="status" class="status" aria-live="polite"></div>
    </div>

    <div id="list-wrap" class="card">
      <div id="list" style="padding-bottom:10px"></div>
    </div>
  </div>

<script>
  const API_BASE = "https://neckshift-comments.brd-louu.workers.dev";
  const API = API_BASE + "/comments";

  let ADMIN_TOKEN = sessionStorage.getItem("ns_admin_token") || "";
  const isAdminActive = () => !!ADMIN_TOKEN;

  function escapeHtml(s){return (s||"").replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}
  function linkify(s){return (s||"").replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');}

  // Admin panel
  const adminBtn=document.getElementById("adminToggle");
  const adminPanel=document.getElementById("adminPanel");
  const adminPwd=document.getElementById("adminPassword");
  const adminUse=document.getElementById("adminUse");
  const adminCancel=document.getElementById("adminCancel");

  function refreshAdminUI(){
    adminBtn.textContent = isAdminActive() ? "Admin mode: ON" : "Admin mode";
    adminBtn.style.color = isAdminActive() ? "#9fd" : "";
    adminPanel.style.display = "none";
  }
  adminBtn.addEventListener("click", ()=>{
    if (isAdminActive()){
      if (confirm("Disable admin mode?")) {
        ADMIN_TOKEN = "";
        sessionStorage.removeItem("ns_admin_token");
        refreshAdminUI(); loadComments();
      }
    } else {
      adminPanel.style.display="flex"; adminPwd.value=""; adminPwd.focus();
    }
  });
  adminUse.addEventListener("click", async ()=>{
    const t = adminPwd.value.trim(); if (!t) return;
    const resp = await fetch(API_BASE + "/admin/verify", { method:"POST", headers:{ "Authorization":`Bearer ${t}` } });
    const ok = resp.ok && (await resp.json().catch(()=>({ok:false}))).ok;
    if (!ok) { alert("Wrong password"); return; }
    ADMIN_TOKEN = t; sessionStorage.setItem("ns_admin_token", t);
    refreshAdminUI(); loadComments();
  });
  adminCancel.addEventListener("click", ()=>{ adminPanel.style.display="none"; adminPwd.value=""; });
  refreshAdminUI();

  // Submit (avec email/notify)
  document.getElementById('commentForm').addEventListener('submit', async (e)=>{
    e.preventDefault(); const st=document.getElementById('status'); st.textContent="";

    const name=document.getElementById('name').value.trim().slice(0,40);
    const topic=document.getElementById('topic').value;
    const message=document.getElementById('message').value.trim();
    const email=document.getElementById('email').value.trim();
    const notify=document.getElementById('notify').checked;

    if (!message || message.length<2) { st.textContent="Message is too short."; return; }

    try{
      const r = await fetch(API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name, topic, message, email, notify })
      });
      const data = await r.json().catch(()=>null);
      if (!r.ok) {
        st.textContent =
          data?.error === 'invalid_email' ? "Invalid email." :
          data?.error === 'rate_limited' ? "Please wait a minute before posting again." :
          data?.error === 'invalid_topic' ? "Invalid topic." :
          "Sorry, something went wrong.";
        return;
      }
      st.textContent="Thanks! Your comment was posted.";
      e.target.reset();
      loadComments();
    } catch(err) {
      console.error(err); st.textContent="Network error. Please try again.";
    }
  });

  // load + render
  async function loadComments(){
    try{
      const r = await fetch(API);
      const data = await r.json();
      const list = document.getElementById('list');
      list.innerHTML="";

      (data||[]).forEach(c=>{
        const when = new Date(c.created_at||Date.now()).toLocaleString();
        const wrap = document.createElement('div');
        wrap.className='comment';
        wrap.dataset.id = c.id;
        wrap.id = `c-${c.id}`;

        const isOfficial = false; // auteur utilisateur (pas admin)
        const meta =
          `<div class="meta">
             <span class="name">${escapeHtml(c.name || 'Anonymous')}</span>
             ${isOfficial ? '<span class="badge badge-admin">Officiel</span>' : '<span class="badge badge-unverified">Non vÃ©rifiÃ©</span>'}
             ${c.notify ? '<span class="badge" title="They asked to be notified">ðŸ””</span>' : ''}
             <span class="badge badge-topic">${escapeHtml(c.topic || 'other')}</span>
             <time>${when}</time>
           </div>`;

        let html = meta + `<div>${linkify(escapeHtml(c.message || ''))}</div>`;

        // replies (array) ou compat ancienne
        if (Array.isArray(c.replies) && c.replies.length) {
          c.replies.forEach(r=>{
            html += `<div class="reply"><strong>${escapeHtml(r.by || 'Dev')}</strong><br>${linkify(escapeHtml(r.message||''))}
                     <div class="meta" style="margin-top:6px;"><time>${new Date(r.created_at||Date.now()).toLocaleString()}</time></div></div>`;
          });
        } else if (c.reply && c.reply.message) {
          html += `<div class="reply"><strong>${escapeHtml(c.reply.by || 'Dev')}</strong><br>${linkify(escapeHtml(c.reply.message||''))}</div>`;
        }

        if (isAdminActive()) {
          html += `<div class="admin-actions">
                     <button class="btn btn-small" data-action="reply">Reply</button>
                     <button class="btn btn-small" data-action="delete">Delete</button>
                   </div>
                   <div class="replybox">
                     <textarea placeholder="Write a dev replyâ€¦"></textarea>
                     <div class="actions">
                       <button class="btn btn-small" data-action="send-reply">Send</button>
                       <button class="btn btn-small" data-action="cancel-reply">Cancel</button>
                     </div>
                   </div>`;
        }

        wrap.innerHTML = html;
        list.appendChild(wrap);
      });

      if (isAdminActive()) {
        document.querySelectorAll('.comment').forEach(wrap=>{
          const id = wrap.dataset.id;
          const actions = wrap.querySelector('.admin-actions');
          const box = wrap.querySelector('.replybox');
          if (!actions || !box) return;

          const btnReply  = actions.querySelector('[data-action="reply"]');
          const btnDelete = actions.querySelector('[data-action="delete"]');
          const btnSend   = box.querySelector('[data-action="send-reply"]');
          const btnCancel = box.querySelector('[data-action="cancel-reply"]');
          const textarea  = box.querySelector('textarea');

          btnReply.addEventListener('click', ()=>{ box.style.display='block'; textarea.value=''; textarea.focus(); });
          btnCancel.addEventListener('click', ()=>{ box.style.display='none'; textarea.value=''; });

          btnSend.addEventListener('click', async ()=>{
            const text = (textarea.value || '').trim(); if (!text) return;
            const rr = await fetch(`${API}/${id}/reply`, {
              method:"POST",
              headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${ADMIN_TOKEN}` },
              body: JSON.stringify({ reply: text })
            });
            if (!rr.ok) { alert("Reply failed"); return; }
            loadComments();
          });

          btnDelete.addEventListener('click', async ()=>{
            if (!confirm('Delete this comment?')) return;
            const rr = await fetch(`${API}/${id}`, {
              method:"DELETE",
              headers:{ "Authorization":`Bearer ${ADMIN_TOKEN}` }
            });
            if (!rr.ok) { alert("Delete failed"); return; }
            loadComments();
          });
        });
      }

      // si on vient d'une notif Discord ?cid=...
      const url = new URL(location.href);
      const cid = url.searchParams.get('cid');
      if (cid) {
        const el = document.querySelector(`.comment[data-id="${cid}"]`);
        if (el) {
          el.dataset.highlight = "1";
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          if (isAdminActive()) {
            const btn = el.querySelector('.admin-actions [data-action="reply"]');
            btn && btn.click();
          }
        }
      }
    } catch(e) { console.error(e); }
  }

  // on vÃ©rifie un token admin existant
  (async ()=>{
    if (!ADMIN_TOKEN) return loadComments();
    try {
      const r = await fetch(API_BASE + "/admin/verify", { method:"POST", headers:{ "Authorization":`Bearer ${ADMIN_TOKEN}` } });
      const ok = r.ok && (await r.json().catch(()=>({ok:false}))).ok;
      if (!ok) { ADMIN_TOKEN=""; sessionStorage.removeItem("ns_admin_token"); refreshAdminUI(); }
    } catch {}
    loadComments();
  })();
</script>
</body>
</html>
